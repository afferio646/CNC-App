<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schutte Precision Optimizer</title>
    <link rel="manifest" href="/manifest.json">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --border: #334155;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #1a2332 100%);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-content {
            flex-grow: 1;
            text-align: center;
        }

        .header h1 { font-size: 1.5rem; font-weight: 700; margin: 0; }
        .header .subtitle { opacity: 0.9; font-size: 0.95rem; }
        .company-tag {
            display: inline-block;
            background: rgba(255,255,255,0.15);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-top: 1rem;
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 2rem 1.5rem; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 1.75rem;
            border-radius: 16px;
            border: 1px solid var(--border);
            border-top: 3px solid var(--primary);
        }

        .stat-label { color: var(--text-secondary); font-size: 0.875rem; text-transform: uppercase; margin-bottom: 0.75rem; }
        .stat-value { font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem; }
        .stat-trend { font-size: 0.875rem; color: var(--success); }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            padding: 1rem 2.5rem;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
            transition: all 0.3s;
        }

        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(37, 99, 235, 0.4); }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border);
            padding: 0.875rem 2rem;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .action-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .action-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(37, 99, 235, 0.2);
            border-color: var(--primary);
        }

        .sample-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .sample-card {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
        }

        .sample-card:hover {
            transform: translateY(-4px);
            border-color: var(--primary);
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.3);
        }

        .sample-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: #1a1a1a;
        }

        .sample-info { padding: 1.25rem; }
        .sample-title { font-weight: 600; margin-bottom: 0.5rem; }
        .sample-desc { font-size: 0.875rem; color: var(--text-secondary); }

        .camera-view {
            background: #000;
            border-radius: 16px;
            overflow: hidden;
            position: relative;
            margin: 2rem 0;
            border: 2px solid var(--border);
        }

        .camera-preview {
            width: 100%;
            height: auto;
            display: block;
            max-height: 600px;
            object-fit: contain;
        }

        .camera-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
        }

        .detection-box {
            position: absolute;
            border: 3px solid;
            border-radius: 8px;
            animation: boxAppear 0.5s ease-out;
        }

        @keyframes boxAppear {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        .detection-box.high { border-color: var(--danger); box-shadow: 0 0 20px rgba(239, 68, 68, 0.6); }
        .detection-box.medium { border-color: var(--warning); box-shadow: 0 0 20px rgba(245, 158, 11, 0.6); }

        .detection-label {
            position: absolute;
            top: -32px;
            left: 0;
            background: rgba(0, 0, 0, 0.9);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            white-space: nowrap;
            animation: labelSlide 0.3s ease-out 0.3s both;
        }

        @keyframes labelSlide {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .camera-controls {
            padding: 1.5rem;
            background: rgba(15, 23, 42, 0.95);
            display: flex;
            justify-content: center;
        }

        .analysis-status {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            margin: 2rem 0;
        }

        .progress-bar-container {
            width: 100%;
            height: 8px;
            background: rgba(37, 99, 235, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin: 1.5rem 0;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-dark));
            width: 0%;
            transition: width 0.3s;
        }

        .status-text { color: var(--text-secondary); margin-top: 1rem; }

        .results-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .summary-card {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .summary-card.confidence { border-left: 3px solid var(--primary); }
        .summary-card.issues { border-left: 3px solid var(--danger); }
        .summary-card.cost { border-left: 3px solid var(--warning); }

        .summary-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }

        .summary-value { font-size: 2.25rem; font-weight: 700; line-height: 1; }

        .issues-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
            margin: 2rem 0;
        }

        .issues-header {
            background: rgba(37, 99, 235, 0.1);
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .issue-item { padding: 1.5rem; border-bottom: 1px solid var(--border); }
        .issue-item:last-child { border-bottom: none; }

        .issue-header-row {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .issue-title { font-size: 1.125rem; font-weight: 600; margin-bottom: 0.25rem; }
        .issue-location { color: var(--text-secondary); font-size: 0.875rem; }

        .severity-badge {
            padding: 0.375rem 0.875rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .severity-high {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .severity-medium {
            background: rgba(245, 158, 11, 0.2);
            color: #fcd34d;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .issue-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .meta-label { color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 0.25rem; }
        .meta-value { font-weight: 600; }

        .hidden { display: none !important; }
        .modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(4px);
}

.modal-content {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 16px;
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    animation: modalAppear 0.3s ease-out;
}

@keyframes modalAppear {
    from { opacity: 0; transform: scale(0.9) translateY(-20px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
}

.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    font-size: 1.5rem;
    margin: 0;
}

.modal-close {
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: 2rem;
    cursor: pointer;
    line-height: 1;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    transition: all 0.2s;
}

.modal-close:hover {
    background: rgba(255, 255, 255, 0.1);
    color: var(--text-primary);
}

.modal-body {
    padding: 1.5rem;
    overflow-y: auto;
}

.modal-footer {
    padding: 1.5rem;
    border-top: 1px solid var(--border);
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-group:last-child {
    margin-bottom: 0;
}

.form-group label {
    display: block;
    color: var(--text-secondary);
    font-size: 0.875rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.form-input {
    width: 100%;
    background: var(--bg-dark);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.75rem;
    color: var(--text-primary);
    font-size: 1rem;
    font-family: inherit;
    transition: all 0.2s;
}

.form-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.form-input::placeholder {
    color: var(--text-secondary);
    opacity: 0.5;
}

textarea.form-input {
    resize: vertical;
    min-height: 80px;
}
.menu-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 8px;
    transition: background 0.2s;
}

.menu-btn:hover {
    background: rgba(255, 255, 255, 0.1);
}

.menu-btn svg {
    width: 28px;
    height: 28px;
    stroke: var(--text-primary);
    stroke-width: 2.5;
}

.side-menu {
    position: fixed;
    top: 0;
    left: -300px;
    width: 300px;
    height: 100%;
    background: var(--bg-dark);
    box-shadow: 4px 0 15px rgba(0,0,0,0.3);
    z-index: 1001;
    transition: left 0.3s ease;
    display: flex;
    flex-direction: column;
}

.side-menu.open {
    left: 0;
}

.menu-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border);
}

.menu-header h2 {
    font-size: 1.25rem;
    margin-bottom: 0.25rem;
}

.menu-header p {
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.menu-nav {
    flex-grow: 1;
    list-style: none;
    padding: 1rem 0;
}

.menu-nav a {
    display: block;
    color: var(--text-primary);
    text-decoration: none;
    padding: 1rem 1.5rem;
    font-size: 1rem;
    font-weight: 500;
    border-left: 3px solid transparent;
    transition: all 0.2s;
}

.menu-nav a:hover, .menu-nav a.active {
    background: rgba(37, 99, 235, 0.1);
    border-left-color: var(--primary);
    color: var(--primary);
}

.menu-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease;
}

.menu-overlay.open {
    opacity: 1;
    visibility: visible;
}


        @media (max-width: 768px) {
            .stats-grid, .sample-grid, .results-summary { grid-template-columns: 1fr; }
        }
        /* --- NEW STYLES FOR UTILITY HUB GRID --- */
.utility-selection-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-top: 2rem;
}

.utility-card {
    background: var(--bg-card);
    padding: 1.5rem;
    border-radius: 12px;
    border: 1px solid var(--border);
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    text-align: center; /* Center the content */
}

.utility-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
}

.utility-card h2 {
    color: var(--primary-light); 
    font-size: 1.4rem;
    margin-bottom: 0.5rem;
}

.utility-card p {
    color: var(--text-secondary);
}
        /* --- NEW STYLES FOR UTILITY INPUT FORMS (Wow Factor) --- */
.content-header {
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.content-header h1 {
    font-size: 2rem;
    margin: 0;
}

.input-group {
    margin-bottom: 1.5rem;
    padding: 1.25rem;
    background: var(--bg-dark); /* Darker background for input areas */
    border: 1px solid var(--border);
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
}

.input-group label {
    display: block;
    color: var(--text-secondary);
    font-size: 0.875rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.input-group input, .input-group select {
    width: 100%;
    background: rgba(255, 255, 255, 0.05); /* Semi-transparent background for input fields */
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.875rem;
    color: var(--text-primary);
    font-size: 1rem;
    font-family: inherit;
    transition: all 0.3s;
}

.input-group input:focus, .input-group select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
}

.util-title {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 0.5rem;
}

.util-desc {
    color: var(--text-secondary);
    margin-bottom: 1.5rem;
}
.large-btn {
    width: 100%;
    margin-top: 1.5rem;
    padding: 1.25rem 2.5rem;
}
.back-btn {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 1rem;
    padding: 0;
    transition: color 0.2s;
}
.back-btn:hover {
    color: var(--primary);
}
    </style>
</head>
<body>
    <div id="sideMenu" class="side-menu">
        <div class="menu-header">
           <h2>Schutte Precision Optimizer</h2>
            <p>Menu</p>
        </div>
        <nav class="menu-nav">
            <a href="#" onclick="showDashboardView()">Dashboard</a>
            <a href="#" onclick="showProjectsView()">Projects</a>
            <a href="#" onclick="showSettingsView()">Settings</a>
        </nav>
    </div>
    <div id="menuOverlay" class="menu-overlay" onclick="toggleMenu()"></div>

    <div class="header">
        <button class="menu-btn" onclick="toggleMenu()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        </button>
        <div class="header-content">
            <h1>Schutte Precision Optimizer</h1>
        </div>
        <div style="width: 44px;"></div> <!-- Spacer -->
    </div>

    <div class="container">
        <!-- Dashboard -->
        <div id="dashboardView">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Calculations</div>
                    <div class="stat-value">47</div>
                    <div class="stat-trend">↑ 12% this month</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Issues Detected</div>
                    <div class="stat-value">12</div>
                    <div class="stat-trend">3 high priority</div>
                </div>
            </div>

       <div class="utility-selection-grid">
    
    <div class="utility-card" onclick="startUtility('mrr')">
        <h2>1. MRR Performance Calculator</h2>
        <p>Compare Schutte spindle capabilities for quantifiable output gains.</p>
    </div>
    
    <div class="utility-card" onclick="startUtility('recommend')">
        <h2>2. Project Efficiency Advisor</h2>
        <p>Get instant recommendations for optimal setup to maximize uptime.</p>
    </div>
    
    <div class="utility-card" onclick="startUtility('verify')">
        <h2>3. Calculation Verification</h2>
        <p>Verify critical feeds/speeds to prevent costly tool breakage and job failures.</p>
    </div>
           </div> 
        </div>
       
<div id="inputView" class="hidden">
    <div class="content-header">
        <button onclick="showDashboardView()" class="back-btn">← Back to Menu</button>
        <h1>Utility Input</h1>
    </div>
    
    <div class="main-content">
        <div id="utilityFormContainer" class="card">
            <p>Loading form...</p>
        </div>
        
        <button class="btn-primary large-btn" id="calculateBtn" onclick="runCalculation()">Calculate Results</button>
        
        <div id="calculationStatus" class="status-card hidden">
            <div class="progress-bar-container">
                <div id="progressBar" class="progress-bar"></div>
            </div>
            <p id="statusText">Executing calculation...</p>
        </div>
    </div>
</div>
        <!-- Sample Selection -->
        <div id="sampleView" class="hidden">
            <button class="btn-secondary" onclick="showDashboard()">← Back</button>
            <h2 style="margin: 2rem 0 1rem; font-size: 1.75rem;">Select Sample to Analyze</h2>
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">Choose a structural issue to see AI detection in action</p>
            
            <div class="sample-grid">
                <div class="sample-card" onclick="selectSample('water')">
                    <img src='https://i.imgur.com/sVkNhey.jpg'w=400&h=300&fit=crop" class="sample-image" alt="Water Damage">
                    <div class="sample-info">
                        <div class="sample-title">Water Damage - Wall</div>
                        <div class="sample-desc">Visible water staining with potential mold growth</div>
                    </div>
                </div>
                <div class="sample-card" onclick="selectSample('crack')">
                    <img src='https://i.imgur.com/AnkAyMC.jpg'w=400&h=300&fit=crop" class="sample-image" alt="Wall Crack">
                    <div class="sample-info">
                        <div class="sample-title">Structural Crack - Wall</div>
                        <div class="sample-desc">Vertical crack indicating settlement issues</div>
                    </div>
                </div>
                <div class="sample-card" onclick="selectSample('corrosion')">
                    <img src='https://i.imgur.com/6jrvabV.jpg'w=400&h=300&fit=crop" class="sample-image" alt="Pipe Corrosion">
                    <div class="sample-info">
                        <div class="sample-title">Pipe Corrosion</div>
                        <div class="sample-desc">Metal corrosion on exposed plumbing</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Camera/Analysis -->
        <div id="cameraView" class="hidden">
            <button class="btn-secondary" onclick="showSamples()">← Back</button>
            
            <div class="camera-view">
                <img id="previewImage" class="camera-preview" alt="Preview">
                <div class="camera-overlay" id="detectionOverlay"></div>
                <div class="camera-controls">
                    <button class="btn-primary" id="analyzeBtn" onclick="runAnalysis()">Analyze Image</button>
                </div>
            </div>

            <div id="analysisStatus" class="analysis-status hidden">
                <h3>AI Analysis in Progress</h3>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <div class="status-text" id="statusText">Initializing detection algorithms...</div>
            </div>
        </div>

        <!-- Results -->
        <div id="resultsView" class="hidden">
            <button class="btn-secondary" onclick="showDashboard()">← Start New Calculation</button>
            
            <h2 style="font-size: 2rem; margin: 2rem 0 0.5rem;">Analysis Complete</h2>
            <p style="color: var(--text-secondary); margin-bottom: 2rem;">Completed • <span id="timestamp"></span></p>

            <div class="camera-view">
                <img id="resultImage" class="camera-preview" alt="Result">
                <div class="camera-overlay" id="resultOverlay"></div>
            </div>

            <div class="results-summary">
                <div class="summary-card confidence">
                    <div class="summary-label">Confidence</div>
                    <div class="summary-value" style="color: var(--primary);" id="confidenceValue">91%</div>
                </div>
                <div class="summary-card issues">
                    <div class="summary-label">Issues Found</div>
                    <div class="summary-value" style="color: var(--danger);" id="issuesCount">1</div>
                </div>
                <div class="summary-card cost">
                    <div class="summary-label">Value</div>
                    <div class="summary-value" style="color: var(--warning); font-size: 1.75rem;" id="costValue">TBD</div>
                </div>
            </div>

            <div class="issues-container">
                <div class="issues-header">
                    <h3>Detected Issues</h3>
                </div>
                <div id="issuesList"></div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 2rem;">
                <button class="btn-primary" onclick="exportPDF()">Export Full Report</button>
                </div>
        </div>

        <!-- Projects View -->
        <div id="projectsView" class="hidden">
            <h2 style="font-size: 2rem; margin-bottom: 1rem;">Projects</h2>
            <div id="projectList" class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));">
                 <!-- Projects will be dynamically inserted here -->
                <div class="stat-card" style="cursor: pointer;" onclick="showProjectDetailView()">
                    <div class="stat-label">123 Main Street</div>
                    <div class="stat-value" style="font-size: 1.5rem;">3 Scans</div>
                    <div class="stat-trend">Last scan: 11/08/2025</div>
                </div>
                 <div class="stat-card" style="cursor: pointer;" onclick="alert('Navigate to project details')">
                    <div class="stat-label">Downtown Pipe Inspection</div>
                    <div class="stat-value" style="font-size: 1.5rem;">1 Scan</div>
                    <div class="stat-trend">Last scan: 11/05/2025</div>
                </div>
                <div class="action-card" onclick="openProjectModal()">
                     <h3 style="margin-bottom: 1rem;">Create New Project</h3>
                    <p>Start a new scan and save it as a new project.</p>
                </div>
            </div>
        </div>

        <!-- Settings View -->
        <div id="settingsView" class="hidden">
            <h2 style="font-size: 2rem; margin-bottom: 2rem;">Settings</h2>
            <div class="form-group">
                <label>Company Name</label>
                <input type="text" id="companyName" placeholder="e.g., Schutte Precision Optimizer" class="form-input">
            </div>
            <div class="form-group">
                <label>Company Address</label>
                <input type="text" id="companyAddress" placeholder="e.g., 123 Main St, Fort Wayne, IN" class="form-input">
            </div>
            <div class="form-group">
                <label>Contact Info</label>
                <input type="text" id="contactInfo" placeholder="e.g., John Smith (555) 123-4567" class="form-input">
            </div>
            <button class="btn-primary" onclick="saveSettings()" style="margin-right: 1rem;">Save Settings</button>
            <button class="btn-secondary" onclick="requestNotificationPermission()">Enable Notifications</button>
        </div>

        <!-- Project Detail View -->
        <div id="projectDetailView" class="hidden">
            <button class="btn-secondary" onclick="showProjectsView()">← Back to Projects</button>
            <div id="projectDetailHeader" style="margin: 2rem 0;">
                <!-- Project details will be injected here -->
            </div>
            <div id="projectScansList" class="sample-grid" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));">
                <!-- Scans will be injected here -->
            </div>
        </div>
    </div>
<!-- Project Setup Modal -->
<div id="projectModal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Create New Scan</h2>
            <button class="modal-close" onclick="closeProjectModal()">×</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="projectName">Project Name</label>
                <input type="text" id="projectName" placeholder="e.g., 123 Main Street Inspection" class="form-input">
            </div>
            <div class="form-group">
                <label for="propertyAddress">Property Address (Optional)</label>
                <input type="text" id="propertyAddress" placeholder="e.g., 123 Main St, Fort Wayne, IN" class="form-input">
            </div>
            <div class="form-group">
                <label for="clientName">Client Name (Optional)</label>
                <input type="text" id="clientName" placeholder="e.g., John Smith" class="form-input">
            </div>
            <div class="form-group">
                <label for="scanNotes">Notes (Optional)</label>
                <textarea id="scanNotes" placeholder="Add any relevant notes..." class="form-input" rows="3"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeProjectModal()">Cancel</button>
            <button class="btn-primary" onclick="saveProjectAndContinue()">Continue to Scan</button>
        </div>
    </div>
</div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
   <script>
// =======================================================
// === GLOBAL VARIABLES & MOCK DATA (SCHUTTE P-OPT PWA) ===
// =======================================================
    // --- Global Tracking Variables ---
    let currentSample = null;
    let currentProject = null;
    let currentLeadId = null;
    let currentExhId = null;
    let mockScansRemaining = 25; // Define the starting cap for the demo
    window.selectedSampleKey = null; 
    let currentUtilityMode = null; // NEW: Tracks 'mrr', 'recommend', or 'verify'

    const VAPID_PUBLIC_KEY = 'YOUR_VAPID_PUBLIC_KEY_HERE'; 
    const BACKEND_URL = 'YOUR_SECURE_BACKEND_URL'; 

    const allViews = ['dashboardView', 'inputView', 'resultsView', 'projectsView', 'settingsView', 'projectDetailView', 'sampleView', 'cameraView'];

    // =======================================================
    // === PWA CORE FUNCTIONS (VIEW & DATA MANAGEMENT) ===
    // =======================================================

    // Utility Function to get URL Parameters
    function getUrlParameter(name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        const results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    }
    
    // --- View Management Functions ---
    function toggleMenu() {
        document.getElementById('sideMenu').classList.toggle('open');
        document.getElementById('menuOverlay').classList.toggle('open');
    }

    function showView(viewId) {
        allViews.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.classList.add('hidden');
        });
        const targetEl = document.getElementById(viewId);
        if (targetEl) targetEl.classList.remove('hidden');
        
        // Close menu if open
        const sideMenu = document.getElementById('sideMenu');
        const menuOverlay = document.getElementById('menuOverlay');
        if (sideMenu) sideMenu.classList.remove('open');
        if (menuOverlay) menuOverlay.classList.remove('open');
    }

    function showDashboardView() { showView('dashboardView'); }
    function showProjectsView() { showView('projectsView'); } 
    function showSettingsView() { showView('settingsView'); } 
       function showProjectDetailView() { showView('projectDetailView'); }
    
    // --- Project/Settings Management Stubs ---
    function getProjects() { return JSON.parse(localStorage.getItem('struc_projects') || '[]'); }
    function saveProjects(projects) { localStorage.setItem('struc_projects', JSON.stringify(projects)); }
    function loadSettings() { /* ... (settings loading stub) ... */ }
    function saveSettings() { alert('Settings saved! (Mock)'); showDashboardView(); }
    
    // =======================================================
    // === SCHUTTE P-OPT UTILITY HUB LOGIC ===
    // =======================================================
// --- Modal Control Functions ---
function openProjectModal() {
    document.getElementById('projectModal').classList.remove('hidden');
}

function closeProjectModal() {
    document.getElementById('projectModal').classList.add('hidden');
}

// --- FUNCTION: Save Project Details and Continue to Input View ---
function saveProjectAndContinue() {
    const name = document.getElementById('projectName').value;
    const address = document.getElementById('propertyAddress').value;
    const notes = document.getElementById('scanNotes').value;
    
    if (!name) {
        alert("Please enter a Project Name to continue.");
        return;
    }
    
    // MOCK SAVING LOGIC: This captures the data you need
    console.log(`[AfferioIQ] Project Created: ${name} at ${address}`);
    currentProject = { name, address, notes, mode: currentUtilityMode };
    
    closeProjectModal();
    
    // Transition to the input view
    showView('inputView'); 
    
    // Set the calculation button text based on the stored mode
    document.getElementById('calculateBtn').textContent = 
        currentUtilityMode === 'verify' ? 'Verify Calculations' : 'Calculate Results';
}
  // --- NEW FUNCTION: Starts the chosen utility mode by opening the project modal ---
function startUtility(mode) {
    currentUtilityMode = mode;
    window.selectedSampleKey = mode; // For compatibility
    
    // Clear any previous inputs when starting a new utility flow
    document.getElementById('projectName').value = ''; 
    document.getElementById('propertyAddress').value = '';
    document.getElementById('clientName').value = '';
    document.getElementById('scanNotes').value = '';
    
    // RENDER THE FORM DATA FIRST (but don't show the view yet)
    renderInputForm(mode); 

    // Open the Project Modal to capture project details
    openProjectModal(); 
}
   
    // --- NEW FUNCTION: Dynamically loads the input form based on mode ---
    function renderInputForm(mode) {
        const formContainer = document.getElementById('utilityFormContainer');
        let html = '';
        
        if (mode === 'mrr') {
            html = `
                <h3 class="util-title">1. MRR Performance Calculator</h3>
                <p class="util-desc">Compare your current output vs. the achievable rate with Schutte technology.</p>
                <div class="input-group"><label>Tool Diameter (in)</label><input type="number" id="inputToolDia" value="0.5"></div>
                <div class="input-group"><label>Current Spindle RPM</label><input type="number" id="inputRPM" value="8000"></div>
                <div class="input-group"><label>Axial Depth of Cut (in)</label><input type="number" id="inputADOC" value="0.15"></div>
                <div class="input-group"><label>Feed Rate (IPM)</label><input type="number" id="inputFeed" value="100"></div>
            `;
        } else if (mode === 'recommend') {
            html = `
                <h3 class="util-title">2. Project Efficiency Advisor</h3>
                <p class="util-desc">Analyze your constraints to maximize uptime and reduce chatter.</p>
                <div class="input-group"><label>Material</label>
                    <select id="inputMaterial" class="input-select"><option>Titanium G5</option><option>Alloy 6061</option><option>Stainless Steel</option></select>
                </div>
                <div class="input-group"><label>Fixture Rigidity</label>
                    <select id="inputRigidity" class="input-select"><option value="High">High (Welded)</option><option value="Medium">Medium (Clamped)</option><option value="Low">Low (Temporary)</option></select>
                </div>
                <div class="input-group"><label>Target Surface Finish (Ra)</label><input type="number" id="inputRa" value="32"></div>
            `;
        } else if (mode === 'verify') {
            html = `
                <h3 class="util-title">3. Calculation Verification</h3>
                <p class="util-desc">Verify critical feeds and speeds to ensure machine safety and optimal torque limits.</p>
                <div class="input-group"><label>Calculated Feed Rate (IPM)</label><input type="number" id="inputVerifyFeed" value="150"></div>
                <div class="input-group"><label>Target Spindle Speed (RPM)</label><input type="number" id="inputVerifyRPM" value="12000"></div>
                <div class="input-group"><label>Material Strength Factor</label><input type="number" id="inputStrength" value="1.8"></div>
            `;
        }
        
        formContainer.innerHTML = html;
    }

    // --- NEW FUNCTION: Primary calculation function called by the button ---
    async function runCalculation() {
        if (!currentLeadId) { 
            currentLeadId = 'DEMO_MODE'; 
        }

        document.getElementById('calculateBtn').disabled = true;
        document.getElementById('calculationStatus').classList.remove('hidden');

        const analysisResult = await executeCalculationMock(currentUtilityMode); 

        if (analysisResult.success) {
            currentSample = analysisResult.data; 
            await animateProgressBar(); 
            showResults(); 
        } else {
            alert(`Calculation failed: ${analysisResult.message}`);
            document.getElementById('calculationStatus').classList.add('hidden');
            document.getElementById('calculateBtn').disabled = false;
        }
    }
    
    // --- NEW FUNCTION: Mock calculation logic for the demo ---
    async function executeCalculationMock(mode) {
        console.log(`[Schutte P-Opt Sim] Executing calculation for mode: ${mode}`);
        
        // --- SIMULATED USAGE CHECK (Metered Logic retained) ---
        if (mockScansRemaining <= 0) { 
             return { success: false, message: 'USAGE_CAP_REACHED' };
        }
        mockScansRemaining -= 1; 
        
        await new Promise(r => setTimeout(r, 1000));

        let data = {};
        
        // 1. MRR Calculation Mock (High quantifiable savings)
        if (mode === 'mrr') {
            const inputRPM = parseFloat(document.getElementById('inputRPM').value) || 8000;
            const inputFeed = parseFloat(document.getElementById('inputFeed').value) || 100;
            const inputADOC = parseFloat(document.getElementById('inputADOC').value) || 0.15;
            
            const currentMRR = (inputFeed * 0.25 * inputADOC).toFixed(2); 
            const schutteMRR = (currentMRR * 1.4).toFixed(2); 
            const savings = (schutteMRR - currentMRR) * 60 * 8 * 250 * 0.05; 

            data = {
                type: 'MRR_RESULT',
                title: 'MRR Performance Analysis',
                metrics: {
                    currentMRR: `${currentMRR} in³/min`,
                    schutteMRR: `${schutteMRR} in³/min`,
                    savings: `$${savings.toFixed(0)} Annual Savings`
                }
            };

        // 2. Recommendation/Efficiency Mock (Consultative value)
        } else if (mode === 'recommend') {
            const rigidity = document.getElementById('inputRigidity').value;
            const material = document.getElementById('inputMaterial').value;
            const score = rigidity === 'Low' ? 65 : 88;
            
            data = {
                type: 'RECOMMENDATION_RESULT',
                title: 'Project Efficiency Advisor',
                metrics: {
                    score: `${score}% Efficiency Score`,
                    material: material,
                    recommendation: rigidity === 'Low' ? 
                        "Upgrade fixturing or reduce depth of cut to avoid severe chatter." : 
                        "Setup is optimal. Focus on increasing cutting speed for faster cycle times."
                }
            };

        // 3. Verification Mock (Safety value)
        } else if (mode === 'verify') {
            const feed = parseFloat(document.getElementById('inputVerifyFeed').value) || 150;
            const rpm = parseFloat(document.getElementById('inputVerifyRPM').value) || 12000;

            const torqueRequired = ((feed * 0.2) / (rpm / 10000)).toFixed(1);
            const status = torqueRequired > 3.0 ? 'Warning' : 'Verified';
            
            data = {
                type: 'VERIFICATION_RESULT',
                title: 'Calculation Verification Status',
                metrics: {
                    torque: `${torqueRequired} ft-lb (Required)`,
                    safety: status,
                    message: status === 'Warning' ? 
                        "TORQUE WARNING: Required torque exceeds typical machine limits. Reduce feed or increase RPM." : 
                        "STATUS: All calculations verified. Proceed with job setup."
                }
            };
        }

        return { success: true, data: data };
    }
    
    // --- Restored Animation (Used for calculation time) ---
    function animateProgressBar() {
        document.getElementById('progressBar').style.width = '0%';
        let progress = 0;
        let statusIndex = 0;
        const statuses = [
            'Analyzing input parameters...', 'Executing proprietary Schutte algorithms...', 
            'Calculating optimization matrices...', 'Finalizing report generation...'
        ];
        
        return new Promise(resolve => {
            const interval = setInterval(() => {
                progress += 5; 
                document.getElementById('progressBar').style.width = progress + '%';
                
                if (progress % 17 < 5 && statusIndex < statuses.length) {
                    document.getElementById('statusText').textContent = statuses[statusIndex];
                    statusIndex++;
                }
                
                if (progress >= 100) {
                    clearInterval(interval);
                    resolve();
                }
            }, 60);
        });
    }

    // --- Final function to display results in the resultsView ---
    function showResults() {
        showView('resultsView'); 
        
        const data = currentSample;
        const scanDate = new Date();
        
        document.getElementById('timestamp').textContent = scanDate.toLocaleString();
        const resultImageEl = document.getElementById('resultImage');
        if (resultImageEl) resultImageEl.style.display = 'none'; 
        
        // Confidence will now display the Project Name
        document.getElementById('confidenceValue').textContent = currentProject ? currentProject.name : 'Quick Calcs'; 
        
        // Issues Found can display the calculation type
        document.getElementById('issuesCount').textContent = data.title.split(' ')[0]; 

        // Est. Value Card displays the primary metric
        document.getElementById('costValue').textContent = data.metrics.savings || data.metrics.score || data.metrics.safety;

        let html = `
            <div class="issue-item">
                <div class="issue-header-row">
                    <div class="issue-title">${data.title}</div>
                    <div class="severity-badge severity-${data.metrics.safety === 'Warning' ? 'high' : 'low'}">RESULT</div>
                </div>
                <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                    ${data.metrics.recommendation || data.metrics.message || 'Analysis Complete.'}
                </p>
            </div>
            <h3 style="margin-top: 2rem;">Key Metrics:</h3>
        `;

        for (const [key, value] of Object.entries(data.metrics)) {
            html += `<p><strong>${key.replace(/([A-Z])/g, ' $1').toUpperCase()}:</strong> ${value}</p>`;
        }
        
        document.getElementById('issuesList').innerHTML = html;
        window.scrollTo(0, 0);
    }


    // --- CORE FUNCTION: Initializes Tracking ---
    function initializeLeadTracking() {
        const urlLeadId = getUrlParameter('leadId');
        const urlExhId = getUrlParameter('exhId');
        const storedLeadId = localStorage.getItem('afferio_leadId');
        const storedExhId = localStorage.getItem('afferio_exhId');

        if (urlLeadId && urlExhId) {
            currentLeadId = urlLeadId;
            currentExhId = urlExhId;
            localStorage.setItem('afferio_leadId', currentLeadId);
            localStorage.setItem('afferio_exhId', currentExhId);
            console.log(`[AfferioIQ] New Session Started. Lead ID: ${currentLeadId}`);

        } else if (storedLeadId && storedExhId) {
            currentLeadId = storedLeadId;
            currentExhId = storedExhId;
            console.log(`[AfferioIQ] Returning User Session. Lead ID: ${currentLeadId}`);
            
        } else {
            currentLeadId = 'DEMO_MODE'; // Set a default ID for the demo to work
            console.warn("[AfferioIQ] DEMO MODE: Tracking Failed.");
        }
    }


    // --- PWA Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        // --- 1. Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => {
                    console.log('Service Worker registered.');
                    initializeLeadTracking(); 
                })
                .catch(error => console.error('Service Worker registration failed:', error));
        } else {
            initializeLeadTracking(); 
        }
        loadSettings(); 
    });
</script>
</body>
</html>
